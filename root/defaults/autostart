
#!/bin/bash
# Ensure Steam autostarts in KDE
mkdir -p "$HOME/.config/autostart"
cat > "$HOME/.config/autostart/steam.desktop" <<EOF
[Desktop Entry]
Type=Application
Exec=steam
Hidden=false
NoDisplay=false
X-GNOME-Autostart-enabled=true
Name=Steam
Comment=Start Steam client
EOF

# Start Sunshine (GameStream server) in the background.
if command -v sunshine >/dev/null 2>&1; then
  if ! pgrep -x sunshine >/dev/null 2>&1; then
    sunshine >/config/sunshine.log 2>&1 &
  fi
fi

# Optional: launch a simple GUI window to prove capture/streaming works.
if command -v selkies-smoke-test >/dev/null 2>&1; then
  selkies-smoke-test
fi

# Prefer KDE Plasma Wayland session with headless weston, fallback to X11 if unavailable
if command -v weston >/dev/null 2>&1 && command -v startplasma-wayland >/dev/null 2>&1; then
  export XDG_SESSION_TYPE=wayland
  export QT_QPA_PLATFORM=wayland
  export WAYLAND_DISPLAY=wayland-0
  weston --headless --socket=wayland-0 &
  # Wait for weston to be ready
  for i in {1..10}; do
    if [ -S /run/user/$(id -u)/wayland-0 ]; then break; fi
    sleep 1
  done
  startplasma-wayland
elif command -v Xorg >/dev/null 2>&1 && command -v startplasma-x11 >/dev/null 2>&1; then
  Xorg :0 -nolisten tcp vt1 &
  export DISPLAY=:0
  for i in {1..10}; do
    if xdpyinfo -display :0 >/dev/null 2>&1; then break; fi
    sleep 1
  done
  startplasma-x11
else
  echo "KDE Plasma (Wayland or X11) not found!"
fi
