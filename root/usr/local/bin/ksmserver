#!/usr/bin/env bash
set -euo pipefail

REAL_KSMSERVER="/usr/bin/ksmserver"
if [ -x /usr/bin/ksmserver.real ]; then
  REAL_KSMSERVER="/usr/bin/ksmserver.real"
fi

log() {
  echo "[steam-selkies][wrap:ksmserver] $*" >>/config/steam-selkies.log 2>/dev/null || true
}

log "uid=$(id -u) gid=$(id -g) user=$(id -un 2>/dev/null || true) HOME=${HOME:-} DISPLAY=${DISPLAY:-} ICEAUTHORITY=${ICEAUTHORITY:-} XAUTHORITY=${XAUTHORITY:-}"

# If ICEAUTHORITY is on /config (often a host bind mount), move it to /tmp to avoid
# libICE lock/link semantics failing on some FUSE-backed filesystems.
if [ -n "${ICEAUTHORITY:-}" ] && printf '%s' "${ICEAUTHORITY}" | grep -q '^/config/'; then
  export ICEAUTHORITY="/tmp/.ICEauthority-abc"
  log "ICEAUTHORITY rewritten to ${ICEAUTHORITY} (local fs)"
fi

if [ -n "${ICEAUTHORITY:-}" ]; then
  if [ -e "${ICEAUTHORITY}" ]; then
    log "ICEAUTHORITY exists: $(ls -l "${ICEAUTHORITY}" 2>/dev/null || true)"
  else
    log "ICEAUTHORITY missing: ${ICEAUTHORITY}"
    touch "${ICEAUTHORITY}" 2>/dev/null || true
    chmod 600 "${ICEAUTHORITY}" 2>/dev/null || true
  fi

  # If the file is empty, seed it. KDE/ICE can treat an empty authority as unusable.
  if [ ! -s "${ICEAUTHORITY}" ] && command -v iceauth >/dev/null 2>&1; then
    # iceauth expects authdata as even-length hex (no 0x prefix).
    cookie_raw="$( (command -v mcookie >/dev/null 2>&1 && mcookie) || (openssl rand -hex 16 2>/dev/null) || echo "" )"
    cookie="$(printf '%s' "${cookie_raw}" | tr -cd '0-9a-fA-F' | tr 'A-F' 'a-f')"
    if [ $(( ${#cookie} % 2 )) -ne 0 ]; then
      cookie="${cookie%?}"
    fi

    if [ -n "${cookie}" ]; then
      set +e
      host="$(hostname 2>/dev/null || echo "")"
      netids=(
        "${DISPLAY:-}"
        "unix${DISPLAY:-}"
        "local/unix${DISPLAY:-}"
        "local/${DISPLAY:-}"
        "${host}/unix${DISPLAY:-}"
        "${host}${DISPLAY:-}"
        "localhost/unix${DISPLAY:-}"
        "localhost${DISPLAY:-}"
      )

      try_seed() {
        local mode="$1" # label
        local protocol_name="$2" # e.g. ICE
        local protocol_data="$3" # e.g. 0 or 1
        local tmpcmd

        tmpcmd="${TMPDIR:-/tmp}/iceauth.cmd.$$"
        {
          for netid in "${netids[@]}"; do
            [ -n "${netid}" ] || continue
            # Per iceauth(1): add protocol_name protocol_data netid authname authdata
            echo "remove ${protocol_name} ${protocol_data} ${netid} MIT-MAGIC-COOKIE-1"
            echo "add ${protocol_name} ${protocol_data} ${netid} MIT-MAGIC-COOKIE-1 ${cookie}"
          done
          echo "list"
          # IMPORTANT: 'exit' saves changes; 'quit' aborts changes.
          echo "exit"
        } >"${tmpcmd}" 2>/dev/null

        out_seed="$(iceauth -f "${ICEAUTHORITY}" <"${tmpcmd}" 2>&1)"
        rc_seed=$?
        rm -f "${tmpcmd}" >/dev/null 2>&1 || true
        size_seed="$(stat -c %s "${ICEAUTHORITY}" 2>/dev/null || echo 0)"

        log "ICEAUTHORITY seed ${mode} rc=${rc_seed} size=${size_seed}"
        # Do NOT log successful output: it contains cookie material.
        if [ -n "${out_seed}" ] && { [ ${rc_seed} -ne 0 ] || [ "${size_seed}" = "0" ]; }; then
          log "iceauth-${mode}: out=$(printf '%s' "${out_seed}" | tr '\n' ' ' | head -c 400)"
        fi

        [ "${size_seed}" != "0" ]
        return $?
      }

      # Try multiple syntaxes. Stop as soon as the file becomes non-empty.
      size0="$(stat -c %s "${ICEAUTHORITY}" 2>/dev/null || echo 0)"
      log "ICEAUTHORITY before-seed size=${size0}"
      log "ICEAUTHORITY seed cookie_hex_len=${#cookie}"

      # protocol_data must be even-length hex (e.g. 00, 01), not "0".
      try_seed "stdin-ICE-00" "ICE" "00" || \
      try_seed "stdin-ICE-01" "ICE" "01" || \
      try_seed "stdin-ICE-00000000" "ICE" "00000000" || true

      # Log a short listing (no secrets) so we can verify entries exist.
      list_out="$(iceauth -f "${ICEAUTHORITY}" list 2>/dev/null | head -n 5)"
      if [ -z "${list_out}" ]; then
        log "iceauth-list: (empty)"
      else
        printf '%s\n' "${list_out}" | while IFS= read -r line; do
          # Expected format: <protocol_name> <protocol_data> <netid> <authname> <authdata>
          set -- ${line}
          if [ "$#" -ge 4 ]; then
            log "iceauth-list: $1 $2 $3 $4 ***"
          else
            log "iceauth-list: ${line}"
          fi
        done
      fi

      set -e
    fi
  fi
fi

exec "${REAL_KSMSERVER}" "$@"
