#!/usr/bin/env bash
set -euo pipefail

log() {
  echo "[steam-selkies][wrap:ksmserver] $*" >>/config/steam-selkies.log 2>/dev/null || true
}

log "uid=$(id -u) gid=$(id -g) user=$(id -un 2>/dev/null || true) HOME=${HOME:-} DISPLAY=${DISPLAY:-} ICEAUTHORITY=${ICEAUTHORITY:-} XAUTHORITY=${XAUTHORITY:-}"

if [ -n "${ICEAUTHORITY:-}" ]; then
  if [ -e "${ICEAUTHORITY}" ]; then
    log "ICEAUTHORITY exists: $(ls -l "${ICEAUTHORITY}" 2>/dev/null || true)"
  else
    log "ICEAUTHORITY missing: ${ICEAUTHORITY}"
    touch "${ICEAUTHORITY}" 2>/dev/null || true
    chmod 600 "${ICEAUTHORITY}" 2>/dev/null || true
  fi

  # If the file is empty, seed it. KDE/ICE can treat an empty authority as unusable.
  if [ ! -s "${ICEAUTHORITY}" ] && command -v iceauth >/dev/null 2>&1; then
    cookie="$( (command -v mcookie >/dev/null 2>&1 && mcookie) || (openssl rand -hex 16 2>/dev/null) || echo "" )"
    if [ -n "${cookie}" ]; then
      set +e
      host="$(hostname 2>/dev/null || echo "")"
      netids=(
        "${DISPLAY:-}"
        "unix${DISPLAY:-}"
        "local/unix${DISPLAY:-}"
        "local/${DISPLAY:-}"
        "${host}/unix${DISPLAY:-}"
        "${host}${DISPLAY:-}"
        "localhost/unix${DISPLAY:-}"
        "localhost${DISPLAY:-}"
      )

      try_seed() {
        local mode="$1" # label
        local protocol_name="$2" # e.g. ICE
        local protocol_data="$3" # e.g. 0 or 1
        local prefix_0x="$4" # either "0x" or ""
        local tmpcmd

        tmpcmd="${TMPDIR:-/tmp}/iceauth.cmd.$$"
        {
          for netid in "${netids[@]}"; do
            [ -n "${netid}" ] || continue
            # Per iceauth(1): add protocol_name protocol_data netid authname authdata
            echo "remove ${protocol_name} ${protocol_data} ${netid} MIT-MAGIC-COOKIE-1"
            echo "add ${protocol_name} ${protocol_data} ${netid} MIT-MAGIC-COOKIE-1 ${prefix_0x}${cookie}"
          done
          echo "list"
          echo "quit"
        } >"${tmpcmd}" 2>/dev/null

        out_seed="$(iceauth -f "${ICEAUTHORITY}" <"${tmpcmd}" 2>&1)"
        rc_seed=$?
        rm -f "${tmpcmd}" >/dev/null 2>&1 || true
        size_seed="$(stat -c %s "${ICEAUTHORITY}" 2>/dev/null || echo 0)"

        log "ICEAUTHORITY seed ${mode} rc=${rc_seed} size=${size_seed}"
        if [ -n "${out_seed}" ]; then
          # Keep it single-line-ish.
          log "iceauth-${mode}: out=$(printf '%s' "${out_seed}" | tr '\n' ' ' | head -c 400)"
        fi

        [ "${size_seed}" != "0" ]
        return $?
      }

      # Try multiple syntaxes. Stop as soon as the file becomes non-empty.
      size0="$(stat -c %s "${ICEAUTHORITY}" 2>/dev/null || echo 0)"
      log "ICEAUTHORITY before-seed size=${size0}"

      try_seed "stdin-ICE-0" "ICE" "0" "" || \
      try_seed "stdin-ICE-0-0x" "ICE" "0" "0x" || \
      try_seed "stdin-ICE-1" "ICE" "1" "" || \
      try_seed "stdin-ICE-1-0x" "ICE" "1" "0x" || true

      # Log a short listing (no secrets) so we can verify entries exist.
      list_out="$(iceauth -f "${ICEAUTHORITY}" list 2>/dev/null | head -n 5)"
      if [ -z "${list_out}" ]; then
        log "iceauth-list: (empty)"
      else
        printf '%s\n' "${list_out}" | while IFS= read -r line; do
          # Expected format: <protocol_name> <protocol_data> <netid> <authname> <authdata>
          set -- ${line}
          if [ "$#" -ge 4 ]; then
            log "iceauth-list: $1 $2 $3 $4 ***"
          else
            log "iceauth-list: ${line}"
          fi
        done
      fi

      set -e
    fi
  fi
fi

exec /usr/bin/ksmserver "$@"
