#!/usr/bin/env bash
set -euo pipefail

log() {
  echo "[steam-selkies][wrap:xrdb] $*" >>/config/steam-selkies.log 2>/dev/null || true
}

log "uid=$(id -u) gid=$(id -g) user=$(id -un 2>/dev/null || true) HOME=${HOME:-} DISPLAY=${DISPLAY:-} XAUTHORITY=${XAUTHORITY:-}"
log "args: $*"

# If called with a file argument, log whether it exists (helps debug kcminit temp races).
for a in "$@"; do
  case "$a" in
    /config/tmp/*|/*)
      if [ -e "$a" ]; then
        perms_line="$(ls -l "$a" 2>/dev/null || true)"
        log "arg-file: exists ${a} -> ${perms_line}"
        if [ ! -r "$a" ]; then
          chmod 600 "$a" 2>/dev/null || true
          log "arg-file: fixed perms (chmod 600) -> $(ls -l "$a" 2>/dev/null || true)"
        fi
      else
        log "arg-file: missing ${a}"
      fi
      ;;
  esac
done

exec /usr/bin/xrdb "$@"
