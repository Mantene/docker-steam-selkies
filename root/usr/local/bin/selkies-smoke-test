#!/bin/bash
set -euo pipefail

if [ "${STEAM_DEBUG_SMOKE_TEST:-}" != "true" ]; then
  exit 0
fi

log_file=/config/steam-selkies.log

(
  echo "steam-selkies: smoke test enabled (STEAM_DEBUG_SMOKE_TEST=true)"
  echo "steam-selkies: attempting to launch xterm to verify compositor+stream"
  echo "steam-selkies: env WAYLAND_DISPLAY=${WAYLAND_DISPLAY-} DISPLAY=${DISPLAY-} XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR-}"
) >>"${log_file}" 2>&1

# Give the compositor/XWayland a moment to come up.
for _ in $(seq 1 10); do
  if [ -n "${DISPLAY-}" ] || pgrep -x Xwayland >/dev/null 2>&1; then
    break
  fi
  sleep 1
done

# If DISPLAY is still missing, try to infer from the Xwayland command line.
if [ -z "${DISPLAY-}" ] && pgrep -x Xwayland >/dev/null 2>&1; then
  xw_display="$(pgrep -a Xwayland | awk '{for(i=1;i<=NF;i++) if ($i ~ /^:[0-9]+$/) {print $i; exit}}')"
  if [ -n "${xw_display}" ]; then
    export DISPLAY="${xw_display}"
    echo "steam-selkies: inferred DISPLAY=${DISPLAY} from Xwayland process" >>"${log_file}" 2>&1
  fi
fi

# As a last resort, pick the first X display that responds.
if [ -z "${DISPLAY-}" ] && command -v xdpyinfo >/dev/null 2>&1; then
  for n in 1 0 2 3 4 5 6 7 8 9; do
    if xdpyinfo -display ":${n}" >/dev/null 2>&1; then
      export DISPLAY=":${n}"
      echo "steam-selkies: inferred DISPLAY=${DISPLAY} from xdpyinfo probe" >>"${log_file}" 2>&1
      break
    fi
  done
fi

if command -v xterm >/dev/null 2>&1; then
  # Prefer launching GUI apps as the non-root user used by linuxserver base images.
  launch_as_user=""
  if command -v su >/dev/null 2>&1 && id abc >/dev/null 2>&1; then
    launch_as_user="abc"
  fi

  # Run in background; keep it visible without stealing focus too aggressively.
  (
    echo "steam-selkies: launching xterm (DISPLAY=${DISPLAY-})";
    if [ -n "${launch_as_user}" ]; then
        su -s /bin/bash "${launch_as_user}" -c "env DISPLAY='${DISPLAY-}' XDG_RUNTIME_DIR='${XDG_RUNTIME_DIR-}' WAYLAND_DISPLAY='${WAYLAND_DISPLAY-}' xterm -title 'Selkies Smoke Test' -geometry 90x24 -e bash -lc 'echo \"Selkies smoke test: if you can see this window, capture+streaming is working.\"; echo; echo \"Close this window when done.\"; exec bash'";
      echo "steam-selkies: xterm (as ${launch_as_user}) exited rc=$?";
    else
      xterm -title "Selkies Smoke Test" -geometry 90x24 -e bash -lc 'echo "Selkies smoke test: if you can see this window, capture+streaming is working."; echo; echo "Close this window when done."; exec bash'
      echo "steam-selkies: xterm exited rc=$?";
    fi
  ) >>"${log_file}" 2>&1 &
  exit 0
fi

(
  echo "steam-selkies: smoke test requested but xterm not found"
) >>"${log_file}" 2>&1

exit 0
